<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Commander Token Board</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="theme-color" content="#111111">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg-dark: #111;
      --bg-panel: #181818;
      --border: #333;
      --accent: #2f7d32;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      -webkit-user-select: none; /* Helps prevent text selection on long press */
      user-select: none;
    }

    /* --- HEADER --- */
    header {
      padding: 10px 16px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      z-index: 10;
    }

    header h1 { font-size: 18px; margin: 0; }
    .header-controls { display: flex; gap: 8px; }

    button {
      background: #444;
      color: #eee;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      touch-action: manipulation;
    }
    button:active { transform: translateY(1px); }

    /* --- LAYOUT --- */
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 300px;
      background: #151515;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 12px;
      gap: 12px;
      flex-shrink: 0;
    }

    .battlefield {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #0a0a0a;
      position: relative;
    }

    /* --- PANELS & FORMS --- */
    .panel {
      background: var(--bg-panel);
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
    }

    h2 { margin: 0 0 10px; font-size: 15px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }

    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
    }
    input:focus, select:focus { outline: 2px solid #555; border-color: transparent; }

    .btn-green { background: var(--accent); color: white; width: 100%; font-weight: bold; }
    .btn-green:hover { background: #3f9d42; }

    /* --- CONTEXT MENU --- */
    #context-menu {
      position: absolute;
      display: none;
      background: #222;
      border: 1px solid #555;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.8);
      z-index: 1000;
      min-width: 160px;
      overflow: hidden;
    }
    .ctx-item {
      padding: 12px 14px; /* Larger tap target for mobile */
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid #333;
    }
    .ctx-item:hover { background: #333; }
    .ctx-item:last-child { border-bottom: none; }
    .ctx-danger { color: #ff6b6b; }

    /* --- PRESETS --- */
    .preset-picker {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 6px;
      max-height: 250px;
      overflow-y: auto;
    }
    .preset-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: #222;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      border: 1px solid transparent;
      touch-action: none; /* Prevents browser zoom/pan on double tap */
    }
    .preset-item:hover { border-color: #666; background: #2a2a2a; }

    /* --- TOKEN GRID --- */
    #tokenList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      padding-bottom: 60px;
    }

    .token {
      position: relative;
      aspect-ratio: 5/7;
      border-radius: 8px;
      border: 2px solid transparent;
      padding: 6px;
      display: flex;
      flex-direction: column;
      user-select: none;
      transition: transform 0.2s ease, box-shadow 0.2s;
      color: #fff;
    }

    /* Shake animation */
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }
    .token.shake { animation: shake 0.3s; }

    /* COLORS */
    .token[data-color="white"] { background: #545450; border-color: #a8a8a0; box-shadow: 0 0 10px rgba(255,255,230,0.2); }
    .token[data-color="blue"] { background: #1d3a5e; border-color: #4a86c0; box-shadow: 0 0 10px rgba(0,100,255,0.3); }
    .token[data-color="black"] { background: #2e2e2e; border-color: #5e5e5e; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .token[data-color="red"] { background: #5e1d1d; border-color: #c04a4a; box-shadow: 0 0 10px rgba(255,50,50,0.3); }
    .token[data-color="green"] { background: #1d4a1d; border-color: #4ac04a; box-shadow: 0 0 10px rgba(0,200,100,0.3); }
    .token[data-color="colorless"] { background: #444444; border-color: #888888; box-shadow: 0 0 10px rgba(150,150,150,0.3); }

    .token.tapped {
      transform: rotate(10deg) translateY(10px);
      opacity: 0.8;
      filter: grayscale(0.3);
    }

    .token-img-container {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border: 1px solid rgba(0,0,0,0.2);
    }
    .token-img { width: 100%; height: 100%; object-fit: cover; }
    .fallback-text { font-size: 40px; color: rgba(255,255,255,0.3); font-weight: 800; }

    .token-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 700;
      height: 24px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }

    .token-qty {
      font-size: 12px;
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .badge {
      position: absolute;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    .pt-badge { bottom: 4px; right: 4px; background: rgba(0,0,0,0.85); border: 1px solid #999; font-size: 14px; color: #fff; }
    .haste-badge { bottom: 4px; left: 4px; background: rgba(200,50,50,0.9); border: 1px solid red; color: #fff; }
    .sick-badge { top: 4px; right: 4px; background: rgba(180,180,0,0.9); border: 1px solid yellow; color: #fff; }

    .token-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 4px;
      margin-top: 4px;
    }
    .token-actions button {
      padding: 4px;
      font-size: 10px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      color: #ddd;
    }
    .token-actions button:hover { background: rgba(0,0,0,0.6); }
    .token-actions button.buff { color: #8f8; }
    .token-actions button.nerf { color: #f88; }

    /* Version Footer */
    .version-tag {
        position: fixed;
        bottom: 5px;
        right: 10px;
        color: #444;
        font-size: 10px;
        pointer-events: none;
        z-index: 100;
    }

    @media (max-width: 768px) {
      main { flex-direction: column; }
      .sidebar {
        width: 100%;
        max-height: 250px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      #tokenList { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
      .token { aspect-ratio: 4/6; }
    }
  </style>
</head>
<body>

<header>
  <h1>Commander Tokens</h1>
  <div class="header-controls">
    <button id="nextTurn">Untap / Next Turn</button>
    <button id="clearTokens" style="color:#ff8888">Reset</button>
  </div>
</header>

<main>
  <div class="sidebar">
    <div class="panel">
      <h2>Quick Add</h2>
      <input id="presetSearch" type="text" placeholder="Search (e.g. Goblin)..." />
      <div id="presetPicker" class="preset-picker"></div>
    </div>

    <div class="panel">
      <h2>Custom Token</h2>
      <form id="tokenForm">
        <input type="text" id="name" placeholder="Name" required />
        <div style="display:flex; gap:8px;">
          <input type="number" id="qty" value="1" min="1" placeholder="Qty" style="flex:1" />
          <select id="color" style="flex:1">
            <option value="white">White</option>
            <option value="blue">Blue</option>
            <option value="black">Black</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="colorless">Colorless</option>
          </select>
        </div>
        <div style="display:flex; gap:8px;">
          <input type="number" id="power" value="1" placeholder="Pow" style="flex:1" />
          <input type="number" id="toughness" value="1" placeholder="Tgh" style="flex:1" />
        </div>
        <input type="file" id="image" accept="image/*" />
        <label style="font-size:12px; display:flex; align-items:center; gap:6px; margin-bottom:10px; cursor:pointer">
          <input type="checkbox" id="haste"> Creature has Haste
        </label>
        <button type="submit" class="btn-green">Create Token</button>
      </form>
    </div>
  </div>

  <div class="battlefield">
    <div id="tokenList"></div>
  </div>
</main>

<div class="version-tag">v1.1 (Long Press Support)</div>

<div id="context-menu"></div>

<script>
  let tokens = [];
  let sessionImages = {};
  let selectedPresetImage = null;

  try {
    tokens = JSON.parse(localStorage.getItem("mtg_tokens")) || [];
  } catch { tokens = []; }

  // --- LOGIC: SMART ADD & MERGE ---
  function addTokenToBoard(newToken) {
    const getImg = (t) => sessionImages[t.id] || t.imagePath || 'none';
    const sig = (t) => `${t.name}|${t.color}|${t.power}|${t.toughness}|${t.counters}|${t.haste}|${t.summoning}|${t.tapped}|${getImg(t)}`;

    const newSignature = sig(newToken);
    const match = tokens.find(t => sig(t) === newSignature);

    if (match) {
      match.qty += newToken.qty;
      if(sessionImages[newToken.id] && newToken.id !== match.id) {
          delete sessionImages[newToken.id];
      }
    } else {
      tokens.push(newToken);
    }
    save();
    render();
  }

  function save() {
    localStorage.setItem("mtg_tokens", JSON.stringify(tokens));
  }

  function render() {
    const list = document.getElementById("tokenList");
    list.innerHTML = "";

    tokens.forEach((t, index) => {
      const card = document.createElement("div");
      card.className = `token ${t.tapped ? 'tapped' : ''}`;
      card.dataset.color = t.color;

      // --- 1. CLICK: TAP HANDLER ---
      card.addEventListener("click", (e) => {
        if(e.target.tagName === "BUTTON") return;

        if (t.summoning && !t.tapped) {
            card.classList.add("shake");
            setTimeout(() => card.classList.remove("shake"), 300);
            return;
        }

        if (t.qty === 1) {
            t.tapped = !t.tapped;
        } else {
            t.qty--;
            const singleToken = JSON.parse(JSON.stringify(t));
            singleToken.qty = 1;
            singleToken.tapped = !t.tapped;
            singleToken.id = crypto.randomUUID();
            if(sessionImages[t.id]) sessionImages[singleToken.id] = sessionImages[t.id];
            addTokenToBoard(singleToken);
            return;
        }
        save();
        render();
      });

      // --- 2. RIGHT CLICK: TOKEN CONTEXT MENU ---
      card.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showTokenContextMenu(e, t, index);
      });

      // Image & Badges
      const imgContainer = document.createElement("div");
      imgContainer.className = "token-img-container";

      let imgSrc = null;
      if (sessionImages[t.id]) imgSrc = sessionImages[t.id];
      else if (t.imagePath) imgSrc = t.imagePath;

      if (imgSrc) {
        const img = document.createElement("img");
        img.src = imgSrc;
        img.className = "token-img";
        img.onerror = function() {
            this.style.display = 'none';
            const fb = document.createElement("div");
            fb.className = "fallback-text";
            fb.innerText = t.name[0];
            imgContainer.appendChild(fb);
        };
        imgContainer.appendChild(img);
      } else {
        const fallback = document.createElement("div");
        fallback.className = "fallback-text";
        fallback.innerText = t.name[0];
        imgContainer.appendChild(fallback);
      }

      const effectivePower = t.power + t.counters;
      const effectiveToughness = t.toughness + t.counters;

      const ptBadge = document.createElement("div");
      ptBadge.className = "badge pt-badge";
      ptBadge.innerText = `${effectivePower}/${effectiveToughness}`;
      imgContainer.appendChild(ptBadge);

      if (t.summoning) {
        const sick = document.createElement("div");
        sick.className = "badge sick-badge";
        sick.innerText = "ZZZ";
        imgContainer.appendChild(sick);
      }
      if (t.haste) {
        const haste = document.createElement("div");
        haste.className = "badge haste-badge";
        haste.innerText = "HASTE";
        imgContainer.appendChild(haste);
      }
      card.appendChild(imgContainer);

      const details = document.createElement("div");
      details.className = "token-details";
      details.innerHTML = `<span>${t.name}</span> <span class="token-qty">x${t.qty}</span>`;
      card.appendChild(details);

      const actions = document.createElement("div");
      actions.className = "token-actions";

      const btnBuff = document.createElement("button");
      btnBuff.className = "buff";
      btnBuff.innerText = "+1/+1";
      btnBuff.onclick = () => { t.counters++; save(); render(); };

      const btnNerf = document.createElement("button");
      btnNerf.className = "nerf";
      btnNerf.innerText = "-1/-1";
      btnNerf.onclick = () => { t.counters--; save(); render(); };

      const btnClone = document.createElement("button");
      btnClone.innerText = "Clone";
      btnClone.onclick = () => {
         const clone = JSON.parse(JSON.stringify(t));
         clone.id = crypto.randomUUID();
         clone.qty = 1;
         clone.summoning = true;
         if(clone.haste) clone.summoning = false;
         clone.tapped = false;
         clone.counters = 0;
         if(sessionImages[t.id]) sessionImages[clone.id] = sessionImages[t.id];
         addTokenToBoard(clone);
      };

      actions.appendChild(btnBuff);
      actions.appendChild(btnNerf);
      actions.appendChild(btnClone);
      card.appendChild(actions);

      list.appendChild(card);
    });
  }

  // --- MENU DISPLAY LOGIC ---
  const ctxMenu = document.getElementById("context-menu");

  function showTokenContextMenu(e, token, index) {
    const action = token.tapped ? "Untap" : "Tap";
    ctxMenu.innerHTML = `
      <div class="ctx-item" id="ctx-tap-x">${action} Specific Amount...</div>
      <div class="ctx-item ctx-danger" id="ctx-kill-1">Destroy 1 (Decrease Qty)</div>
      <div class="ctx-item ctx-danger" id="ctx-kill-all">Delete Entire Stack</div>
    `;
    positionMenu(e.clientX, e.clientY);

    document.getElementById("ctx-tap-x").onclick = () => {
       const input = prompt(`How many to ${action}?`, token.qty);
       if(input) {
         const count = parseInt(input);
         if(count > 0 && count < token.qty) {
            token.qty -= count;
            const newStack = JSON.parse(JSON.stringify(token));
            newStack.qty = count;
            newStack.tapped = !token.tapped;
            newStack.id = crypto.randomUUID();
            if(sessionImages[token.id]) sessionImages[newStack.id] = sessionImages[token.id];
            addTokenToBoard(newStack);
         } else if (count >= token.qty) {
            token.tapped = !token.tapped;
            save(); render();
         }
       }
       ctxMenu.style.display = "none";
    };

    document.getElementById("ctx-kill-1").onclick = () => {
      if (token.qty > 1) {
        token.qty--;
      } else {
        delete sessionImages[token.id];
        tokens.splice(index, 1);
      }
      save(); render();
      ctxMenu.style.display = "none";
    };

    document.getElementById("ctx-kill-all").onclick = () => {
      if(confirm(`Remove all ${token.name} tokens?`)) {
        delete sessionImages[token.id];
        tokens.splice(index, 1);
        save(); render();
      }
      ctxMenu.style.display = "none";
    };
  }

  // --- SHARED MENU HELPER ---
  function positionMenu(x, y) {
    ctxMenu.style.display = "block";
    const adjustedX = Math.min(x, window.innerWidth - 170);
    const adjustedY = Math.min(y, window.innerHeight - 100);
    ctxMenu.style.left = `${adjustedX}px`;
    ctxMenu.style.top = `${adjustedY}px`;
  }

  function showPresetContextMenu(x, y, p) {
    ctxMenu.innerHTML = `<div class="ctx-item" id="ctx-quick-create">Quick Create ${p.name}</div>`;
    positionMenu(x, y);

    document.getElementById("ctx-quick-create").onclick = () => {
        const id = crypto.randomUUID();
        const token = {
            id,
            name: p.name,
            qty: 1,
            color: p.color,
            power: p.power,
            toughness: p.toughness,
            haste: false,
            summoning: true,
            tapped: false,
            counters: 0,
            imagePath: `${p.name}.png`
        };
        addTokenToBoard(token);
        ctxMenu.style.display = "none";
    };
  }

  document.addEventListener("click", (e) => {
    if (!e.target.closest("#context-menu")) {
      ctxMenu.style.display = "none";
    }
  });

  // --- FORM HANDLER ---
  document.getElementById("tokenForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const qty = parseInt(document.getElementById("qty").value);
    const color = document.getElementById("color").value;
    const power = parseInt(document.getElementById("power").value) || 0;
    const toughness = parseInt(document.getElementById("toughness").value) || 1;
    const haste = document.getElementById("haste").checked;
    const file = document.getElementById("image").files[0];

    const id = crypto.randomUUID();
    const newToken = {
      id, name, qty, color, power, toughness, haste,
      summoning: !haste,
      tapped: false,
      counters: 0,
      imagePath: null
    };

    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        sessionImages[id] = reader.result;
        addTokenToBoard(newToken);
      };
      reader.readAsDataURL(file);
    } else {
      if (selectedPresetImage) {
        newToken.imagePath = selectedPresetImage;
        selectedPresetImage = null;
      }
      addTokenToBoard(newToken);
    }

    document.getElementById("name").value = "";
    document.getElementById("image").value = "";
    document.getElementById("name").focus();
  });

  // Next Turn
  document.getElementById("nextTurn").addEventListener("click", () => {
    tokens.forEach(t => { t.summoning = false; t.tapped = false; });
    const consolidated = [];
    const getImg = (t) => sessionImages[t.id] || t.imagePath || 'none';

    tokens.forEach(t => {
        const key = `${t.name}|${t.color}|${t.power}|${t.toughness}|${t.counters}|${t.haste}|${t.summoning}|${t.tapped}|${getImg(t)}`;
        const existing = consolidated.find(c => c.key === key);
        if (existing) {
            existing.token.qty += t.qty;
            if(sessionImages[t.id] && existing.token.id !== t.id) delete sessionImages[t.id];
        } else {
            consolidated.push({ key, token: t });
        }
    });
    tokens = consolidated.map(c => c.token);
    save();
    render();
  });

  document.getElementById("clearTokens").addEventListener("click", () => {
    if(confirm("Clear board?")) {
      tokens = [];
      sessionImages = {};
      save();
      render();
    }
  });

  document.getElementById("presetSearch").addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase();
    Array.from(document.getElementById("presetPicker").children).forEach(child => {
      child.style.display = child.innerText.toLowerCase().includes(term) ? "flex" : "none";
    });
  });

  // --- PRESETS ---
  const PRESETS = {
    angel:        { name: "Angel",        color: "white",     power: 4, toughness: 4 },
    bat:          { name: "Bat",          color: "black",     power: 1, toughness: 1 },
    beast:        { name: "Beast",        color: "green",     power: 3, toughness: 3 },
    bird:         { name: "Bird",         color: "blue",      power: 1, toughness: 1 },
    cat:          { name: "Cat",          color: "white",     power: 2, toughness: 2 },
    clue:         { name: "Clue",         color: "colorless", power: 0, toughness: 0 },
    construct:    { name: "Construct",    color: "colorless", power: 0, toughness: 0 },
    devil:        { name: "Devil",        color: "red",       power: 1, toughness: 1 },
    demon:        { name: "Demon",        color: "black",     power: 5, toughness: 5 },
    drake:        { name: "Drake",        color: "blue",      power: 2, toughness: 2 },
    dragon:       { name: "Dragon",       color: "red",       power: 4, toughness: 4 },
    dwarf:        { name: "Dwarf",        color: "red",       power: 2, toughness: 1 },
    eldrazi_scion:{ name: "Eldrazi Scion",color: "colorless", power: 1, toughness: 1 },
    eldrazi_spawn:{ name: "Eldrazi Spawn",color: "colorless", power: 0, toughness: 1 },
    elf_warrior:  { name: "Elf Warrior",  color: "green",     power: 1, toughness: 1 },
    faerie:       { name: "Faerie",       color: "blue",      power: 1, toughness: 1 },
    fish:         { name: "Fish",         color: "blue",      power: 1, toughness: 1 },
    food:         { name: "Food",         color: "colorless", power: 0, toughness: 0 },
    goblin:       { name: "Goblin",       color: "red",       power: 1, toughness: 1 },
    golem:        { name: "Golem",        color: "colorless", power: 3, toughness: 3 },
    horror:       { name: "Horror",       color: "black",     power: 3, toughness: 3 },
    human:        { name: "Human",        color: "white",     power: 1, toughness: 1 },
    illusion:     { name: "Illusion",     color: "blue",      power: 2, toughness: 2 },
    insect:       { name: "Insect",       color: "green",     power: 1, toughness: 1 },
    knight:       { name: "Knight",       color: "white",     power: 2, toughness: 2 },
    kraken:       { name: "Kraken",       color: "blue",      power: 9, toughness: 9 },
    myr:          { name: "Myr",          color: "colorless", power: 1, toughness: 1 },
    pegasus:      { name: "Pegasus",      color: "white",     power: 1, toughness: 1 },
    plant:        { name: "Plant",        color: "green",     power: 0, toughness: 1 },
    rat:          { name: "Rat",          color: "black",     power: 1, toughness: 1 },
    saproling:    { name: "Saproling",    color: "green",     power: 1, toughness: 1 },
    servo:        { name: "Servo",        color: "colorless", power: 1, toughness: 1 },
    skeleton:     { name: "Skeleton",     color: "black",     power: 1, toughness: 1 },
    soldier:      { name: "Soldier",      color: "white",     power: 1, toughness: 1 },
    spirit:       { name: "Spirit",       color: "white",     power: 1, toughness: 1 },
    spirit_blue:  { name: "Spirit (U)",   color: "blue",      power: 1, toughness: 1 },
    thopter:      { name: "Thopter",      color: "blue",      power: 1, toughness: 1 },
    treasure:     { name: "Treasure",     color: "colorless", power: 0, toughness: 0 },
    warrior:      { name: "Warrior",      color: "red",       power: 1, toughness: 1 },
    wolf:         { name: "Wolf",         color: "green",     power: 2, toughness: 2 },
    zombie:       { name: "Zombie",       color: "black",     power: 2, toughness: 2 },
    zombie_army:  { name: "Zombie Army",  color: "black",     power: 0, toughness: 0 }
  };

  const presetPicker = document.getElementById("presetPicker");
  function getColorCode(c) {
    const map = { white: '#fffacd', blue: '#69c5ff', black: '#a9a9a9', red: '#ff6b6b', green: '#90ee90', colorless: '#d3d3d3' };
    return map[c] || '#fff';
  }

  Object.keys(PRESETS).sort().forEach(key => {
    const p = PRESETS[key];
    const item = document.createElement("div");
    item.className = "preset-item";
    item.innerHTML = `<div style="width:10px; height:10px; border-radius:50%; background:${getColorCode(p.color)}; border:1px solid #555;"></div> <b>${p.name}</b> <span style="color:#888; margin-left:auto; font-size:10px;">${p.power}/${p.toughness}</span>`;

    // --- RIGHT CLICK (DESKTOP) ---
    item.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showPresetContextMenu(e.clientX, e.clientY, p);
    });

    // --- LONG PRESS (MOBILE) ---
    let timer = null;
    let isLongPress = false;

    item.addEventListener("touchstart", (e) => {
        isLongPress = false;
        // Start 500ms timer
        timer = setTimeout(() => {
            isLongPress = true;
            // Get touch coordinates (using first finger)
            const touch = e.touches[0];
            showPresetContextMenu(touch.clientX, touch.clientY, p);
        }, 500);
    }, {passive: true});

    item.addEventListener("touchend", (e) => {
        clearTimeout(timer);
        if (isLongPress) {
            e.preventDefault(); // Prevent click from firing if we just did a long press
        }
    });

    item.addEventListener("touchmove", () => {
        // If scrolling, cancel the long press
        clearTimeout(timer);
    });

    // --- LEFT CLICK (FILL FORM) ---
    item.onclick = (e) => {
      // If we just triggered a long press menu, don't fill the form
      if (isLongPress) return;

      document.getElementById("name").value = p.name;
      document.getElementById("color").value = p.color;
      document.getElementById("power").value = p.power;
      document.getElementById("toughness").value = p.toughness;
      selectedPresetImage = `${p.name}.png`;
      const qtyBox = document.getElementById("qty");
      qtyBox.focus();
      qtyBox.select();
    };

    presetPicker.appendChild(item);
  });

  render();
</script>
</body>
</html>